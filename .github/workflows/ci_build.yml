name: Build MOTSMART Firmware (auto-detect PIO dir, full env)

on:
  push:
    tags:
      - 'v*'                 # build saat push tag, contoh: v0.3.9-safeoff
  workflow_dispatch:         # bisa dijalankan manual dari tab Actions

permissions:
  contents: write            # diperlukan jika membuat Release

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show ref & commit
        run: |
          echo "GITHUB_REF = $GITHUB_REF"
          echo "GITHUB_SHA = $GITHUB_SHA"

      - name: Detect PlatformIO project dir
        id: detect
        run: |
          set -e
          if [ -f "ci_build/platformio.ini" ]; then
            echo "dir=ci_build" >> "$GITHUB_OUTPUT"
          elif [ -f "platformio.ini" ]; then
            echo "dir=." >> "$GITHUB_OUTPUT"
          else
            echo "ERROR: No platformio.ini found in repo root or ci_build/"
            exit 1
          fi
          echo "Detected PIO dir: $(cat $GITHUB_OUTPUT)"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Cache PlatformIO & pip
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio/.cache
            ~/.cache/pip
          key: pio-${{ runner.os }}-${{ hashFiles('**/platformio.ini') }}
          restore-keys: |
            pio-${{ runner.os }}-

      - name: Install PlatformIO
        run: pip install platformio

      - name: Clean build (env full)
        working-directory: ${{ steps.detect.outputs.dir }}
        run: pio run -e full -t clean

      - name: Build (env full) with SAFE_MODE=0 + BUILD_TAG + BYPASS_SAFETY
  working-directory: ci_build
  run: |
    pio run -e full -t clean
    pio run -e full -O 'build_flags=${build_flags} -D SAFE_MODE=0 -D BYPASS_SAFETY=1 -D BUILD_TAG=\"${{ github.ref_name }}\"'

      - name: List built files (debug)
        working-directory: ${{ steps.detect.outputs.dir }}
        run: |
          echo ">>> Tree of .pio/build/full"
          ls -alR .pio/build/full || true
          echo ">>> platformio.ini (peek)"
          head -n 200 platformio.ini || true          done
          ls -al ci_build/.pio/build/full/release || true

      - name: Create GitHub Release & upload assets
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ci_build/.pio/build/full/release/*
          draft: false
          prerelease: false
